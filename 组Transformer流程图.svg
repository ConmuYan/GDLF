<svg width="1200" height="1400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 20px; font-weight: bold; fill: #2c3e50; }
      .subtitle { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #34495e; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .small-text { font-family: Arial, sans-serif; font-size: 10px; fill: #7f8c8d; }
      .input-box { fill: #e8f5e8; stroke: #27ae60; stroke-width: 2; }
      .process-box { fill: #e3f2fd; stroke: #2196f3; stroke-width: 2; }
      .group-box { fill: #fff3e0; stroke: #ff9800; stroke-width: 2; }
      .attention-box { fill: #f3e5f5; stroke: #9c27b0; stroke-width: 2; }
      .output-box { fill: #ffebee; stroke: #f44336; stroke-width: 2; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .group-arrow { stroke: #ff9800; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34495e" />
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="600" y="30" text-anchor="middle" class="title">组 Transformer 数据流程图</text>
  
  <!-- 输入数据 -->
  <rect x="50" y="60" width="200" height="80" class="input-box" rx="5"/>
  <text x="150" y="85" text-anchor="middle" class="subtitle">输入数据</text>
  <text x="150" y="105" text-anchor="middle" class="text">tgt: [18, batch, 512]</text>
  <text x="150" y="125" text-anchor="middle" class="small-text">18个StyleGAN潜在码查询</text>
  
  <rect x="300" y="60" width="200" height="80" class="input-box" rx="5"/>
  <text x="400" y="85" text-anchor="middle" class="subtitle">Memory数据</text>
  <text x="400" y="105" text-anchor="middle" class="text">memory: [4096, batch, 512]</text>
  <text x="400" y="125" text-anchor="middle" class="small-text">64×64特征图展平</text>
  
  <!-- 维度变换 -->
  <rect x="50" y="180" width="200" height="60" class="process-box" rx="5"/>
  <text x="150" y="205" text-anchor="middle" class="subtitle">维度变换</text>
  <text x="150" y="225" text-anchor="middle" class="text">permute(1,2,0)</text>
  
  <!-- 分组查询处理 -->
  <rect x="50" y="280" width="180" height="100" class="group-box" rx="5"/>
  <text x="140" y="305" text-anchor="middle" class="subtitle">分组查询</text>
  <text x="140" y="325" text-anchor="middle" class="text">q_net (groups=4)</text>
  <text x="140" y="345" text-anchor="middle" class="text">[18, batch, 4, 128]</text>
  <text x="140" y="365" text-anchor="middle" class="small-text">4组，每组128维</text>
  
  <!-- 全局查询处理 -->
  <rect x="270" y="280" width="180" height="100" class="group-box" rx="5"/>
  <text x="360" y="305" text-anchor="middle" class="subtitle">全局查询</text>
  <text x="360" y="325" text-anchor="middle" class="text">inter_q_net</text>
  <text x="360" y="345" text-anchor="middle" class="text">[18, batch, 1, 128]</text>
  <text x="360" y="365" text-anchor="middle" class="small-text">全局特征</text>
  
  <!-- Memory处理 -->
  <rect x="500" y="280" width="180" height="100" class="process-box" rx="5"/>
  <text x="590" y="305" text-anchor="middle" class="subtitle">Memory处理</text>
  <text x="590" y="325" text-anchor="middle" class="text">k_net, v_net</text>
  <text x="590" y="345" text-anchor="middle" class="text">[4096, batch, 8, 64]</text>
  <text x="590" y="365" text-anchor="middle" class="small-text">8个注意力头</text>
  
  <!-- 查询融合 -->
  <rect x="150" y="420" width="200" height="80" class="group-box" rx="5"/>
  <text x="250" y="445" text-anchor="middle" class="subtitle">查询融合</text>
  <text x="250" y="465" text-anchor="middle" class="text">q + q_global</text>
  <text x="250" y="485" text-anchor="middle" class="text">[18, batch, 8, 64]</text>
  
  <!-- 注意力计算 -->
  <rect x="200" y="540" width="300" height="120" class="attention-box" rx="5"/>
  <text x="350" y="565" text-anchor="middle" class="subtitle">多头注意力计算</text>
  <text x="350" y="585" text-anchor="middle" class="text">q * (dim ** -0.5)</text>
  <text x="350" y="605" text-anchor="middle" class="text">qk = einsum('bhqd,bhkd->bhqk')</text>
  <text x="350" y="625" text-anchor="middle" class="text">attention = softmax(qk)</text>
  <text x="350" y="645" text-anchor="middle" class="text">output = einsum('bhql,bhld->bhqd')</text>
  
  <!-- 分组融合处理 -->
  <rect x="50" y="700" width="180" height="100" class="group-box" rx="5"/>
  <text x="140" y="725" text-anchor="middle" class="subtitle">组内处理</text>
  <text x="140" y="745" text-anchor="middle" class="text">intra_linear</text>
  <text x="140" y="765" text-anchor="middle" class="text">(groups=4)</text>
  <text x="140" y="785" text-anchor="middle" class="small-text">组内特征变换</text>
  
  <rect x="270" y="700" width="180" height="100" class="group-box" rx="5"/>
  <text x="360" y="725" text-anchor="middle" class="subtitle">组间处理</text>
  <text x="360" y="745" text-anchor="middle" class="text">inter_linear</text>
  <text x="360" y="765" text-anchor="middle" class="text">[18, batch, 128]</text>
  <text x="360" y="785" text-anchor="middle" class="small-text">组间信息交互</text>
  
  <!-- 特征重组 -->
  <rect x="150" y="840" width="200" height="80" class="process-box" rx="5"/>
  <text x="250" y="865" text-anchor="middle" class="subtitle">特征重组</text>
  <text x="250" y="885" text-anchor="middle" class="text">view + 相加</text>
  <text x="250" y="905" text-anchor="middle" class="text">[18, batch, 512]</text>
  
  <!-- 残差连接和归一化 -->
  <rect x="150" y="960" width="200" height="100" class="process-box" rx="5"/>
  <text x="250" y="985" text-anchor="middle" class="subtitle">残差连接</text>
  <text x="250" y="1005" text-anchor="middle" class="text">tgt + dropout(tgt2)</text>
  <text x="250" y="1025" text-anchor="middle" class="text">norm2(tgt)</text>
  <text x="250" y="1045" text-anchor="middle" class="small-text">LayerNorm</text>
  
  <!-- FFN -->
  <rect x="150" y="1100" width="200" height="100" class="process-box" rx="5"/>
  <text x="250" y="1125" text-anchor="middle" class="subtitle">前馈网络</text>
  <text x="250" y="1145" text-anchor="middle" class="text">Linear → ReLU → Linear</text>
  <text x="250" y="1165" text-anchor="middle" class="text">512 → 2048 → 512</text>
  <text x="250" y="1185" text-anchor="middle" class="small-text">FFN + 残差 + LayerNorm</text>
  
  <!-- 最终输出 -->
  <rect x="150" y="1240" width="200" height="80" class="output-box" rx="5"/>
  <text x="250" y="1265" text-anchor="middle" class="subtitle">最终输出</text>
  <text x="250" y="1285" text-anchor="middle" class="text">[18, batch, 512]</text>
  <text x="250" y="1305" text-anchor="middle" class="small-text">StyleGAN潜在码</text>
  
  <!-- 右侧说明 -->
  <rect x="750" y="200" width="400" height="600" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1" rx="5"/>
  <text x="950" y="230" text-anchor="middle" class="subtitle">关键创新点</text>
  
  <text x="770" y="260" class="text">1. 分组机制：</text>
  <text x="790" y="280" class="small-text">• 512维特征分为4组，每组128维</text>
  <text x="790" y="300" class="small-text">• 平衡计算效率和表达能力</text>
  
  <text x="770" y="330" class="text">2. 全局-局部融合：</text>
  <text x="790" y="350" class="small-text">• inter_q_net: 生成全局查询特征</text>
  <text x="790" y="370" class="small-text">• intra_linear: 组内特征变换</text>
  <text x="790" y="390" class="small-text">• inter_linear: 组间信息交互</text>
  
  <text x="770" y="420" class="text">3. 多尺度特征利用：</text>
  <text x="790" y="440" class="small-text">• 特征金字塔网络融合</text>
  <text x="790" y="460" class="small-text">• 高分辨率memory提供空间信息</text>
  
  <text x="770" y="490" class="text">4. 注意力机制：</text>
  <text x="790" y="510" class="small-text">• 8个注意力头，每头64维</text>
  <text x="790" y="530" class="small-text">• 18个查询 × 4096个键值</text>
  <text x="790" y="550" class="small-text">• 缩放点积注意力</text>
  
  <text x="770" y="580" class="text">5. 维度变化：</text>
  <text x="790" y="600" class="small-text">• 输入: [18, batch, 512]</text>
  <text x="790" y="620" class="small-text">• 分组: [18, batch, 4, 128]</text>
  <text x="790" y="640" class="small-text">• 注意力: [18, batch, 8, 64]</text>
  <text x="790" y="660" class="small-text">• 输出: [18, batch, 512]</text>
  
  <text x="770" y="690" class="text">6. 在编码器中的作用：</text>
  <text x="790" y="710" class="small-text">• 将图像特征转换为StyleGAN潜在码</text>
  <text x="790" y="730" class="small-text">• 连接视觉特征和生成模型</text>
  <text x="790" y="750" class="small-text">• 实现高质量的图像重建</text>
  
  <!-- 箭头连接 -->
  <line x1="150" y1="140" x2="150" y2="180" class="arrow"/>
  <line x1="400" y1="140" x2="590" y2="280" class="arrow"/>
  <line x1="150" y1="240" x2="140" y2="280" class="arrow"/>
  <line x1="150" y1="240" x2="360" y2="280" class="arrow"/>
  
  <line x1="140" y1="380" x2="200" y2="420" class="group-arrow"/>
  <line x1="360" y1="380" x2="300" y2="420" class="group-arrow"/>
  
  <line x1="250" y1="500" x2="350" y2="540" class="arrow"/>
  <line x1="590" y1="380" x2="450" y2="540" class="arrow"/>
  
  <line x1="350" y1="660" x2="140" y2="700" class="arrow"/>
  <line x1="350" y1="660" x2="360" y2="700" class="arrow"/>
  
  <line x1="140" y1="800" x2="200" y2="840" class="group-arrow"/>
  <line x1="360" y1="800" x2="300" y2="840" class="group-arrow"/>
  
  <line x1="250" y1="920" x2="250" y2="960" class="arrow"/>
  <line x1="250" y1="1060" x2="250" y2="1100" class="arrow"/>
  <line x1="250" y1="1200" x2="250" y2="1240" class="arrow"/>
</svg>